-- please adjust date

-- This returns a report about free accounts that sent >=3 docs this month and we could nag them about paying us

SELECT AUX.CNT,
       AUX.COMPANY_ID,
       AUX.COMPANY_NAME,
       users.email
FROM (SELECT count(*) AS CNT,
             chargeable_items.user_group_id AS COMPANY_ID,
             user_groups.name AS COMPANY_NAME,
             user_group_invoicings.payment_plan AS PLAN
      FROM chargeable_items AS chargeable_items
      JOIN user_groups ON user_groups.id = chargeable_items.user_group_id
      LEFT JOIN user_group_invoicings ON user_group_invoicings.user_group_id = user_groups.id
      WHERE chargeable_items.type=6
        AND chargeable_items.time > '2017-01-01 00:00:01'
        AND (user_group_invoicings.payment_plan IS NULL OR user_group_invoicings.payment_plan = 0)
      GROUP BY chargeable_items.user_group_id, user_groups.name, user_group_invoicings.payment_plan
      ORDER BY CNT DESC) AS AUX
LEFT JOIN users ON AUX.COMPANY_ID = users.user_group_id
WHERE CNT >= 3
  and users.is_company_admin IS TRUE;
