-- please adjust date

-- This returns a report about free accounts that sent >=3 docs this month and we could nag them about paying us

SELECT AUX.CNT,
       AUX.COMPANY_ID,
       AUX.COMPANY_NAME,
       users.email
FROM (SELECT count(*) AS CNT,
             chargeable_items.company_id AS COMPANY_ID,
             companies.name AS COMPANY_NAME,
             payment_plans.plan AS PLAN
      FROM chargeable_items AS chargeable_items
      JOIN companies ON companies.id = chargeable_items.company_id
      LEFT JOIN payment_plans ON payment_plans.company_id = companies.id
      WHERE chargeable_items.type=6
        AND chargeable_items.time > '2017-01-01 00:00:01'
        AND (payment_plans.plan IS NULL OR payment_plans.plan = 0)
      GROUP BY chargeable_items.company_id, companies.name, payment_plans.plan
      ORDER BY CNT DESC) AS AUX
LEFT JOIN users ON AUX.COMPANY_ID = users.company_id
WHERE CNT >= 3
  and users.is_company_admin IS TRUE;
